<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Copilot Anywhere</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background:#0f1115; color:#edf2f7; }
header { font-size: 1.25rem; margin-bottom: 1rem; }
#inputRow { display:flex; gap:.5rem; margin-bottom:1rem; }
#prompt { flex:1; padding:.5rem .75rem; font-size:1rem; border-radius:6px; border:1px solid #2d3748; background:#1a202c; color:#f7fafc; }
button { padding:.6rem 1rem; background:#3182ce; border:none; color:#fff; border-radius:6px; cursor:pointer; font-weight:600; }
button:disabled { opacity:.5; cursor: not-allowed; }
#log { white-space: pre-wrap; background:#1a202c; padding:1rem; border-radius:8px; min-height:260px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; overflow:auto; }
.tag { display:inline-block; background:#2d3748; padding:2px 6px; margin-right:6px; border-radius:4px; font-size:.75rem; color:#a0aec0; }
.fragment { color:#63b3ed; }
.inbound { color:#cbd5e0; }
.done { color:#9ae6b4; }
.model { color:#f6ad55; }
</style>
</head>
<body>
<header style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
  <span>Copilot Anywhere Web Client</span>
  <button id="enableNotifyBtn" style="background:#4a5568; font-size:.7rem; padding:.4rem .6rem;">Enable Notifications</button>
</header>
<div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-start;">
  <div style="min-width:220px; flex:0 0 220px;">
    <h3 style="margin:0 0 .5rem; font-size:.9rem; letter-spacing:.05em; color:#a0aec0;">Projects</h3>
    <div id="sessions" style="background:#1a202c; padding:.5rem; border-radius:6px; max-height:300px; overflow:auto;"></div>
  </div>
  <div style="flex:1; min-width:320px;">
    <div id="inputRow">
      <input id="prompt" placeholder="Ask anything (Enter to send)" />
      <button id="sendBtn">Send</button>
    </div>
    <div id="activeSessionLabel" style="font-size:.75rem; color:#a0aec0; margin-bottom:.4rem;">No session selected</div>
    <div id="log" aria-live="polite"></div>
  </div>
</div>
<script>
const host = location.origin; // assumes served from root
let sessionNameMap = {}; // id -> name
let currentSession = null; // session id
let sessionEventSource = null;
const logEl = document.getElementById('log');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');

function append(type, text, extra={}) {
  const line = document.createElement('div');
  line.className = type;
  const badge = document.createElement('span');
  badge.className = 'tag';
  badge.textContent = type.toUpperCase();
  line.appendChild(badge);
  if (extra.model) {
    const m = document.createElement('span');
    m.className='tag model';
    m.textContent = extra.model;
    line.appendChild(m);
  }
  const span = document.createElement('span');
  span.textContent = text;
  line.appendChild(span);
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

async function sendPrompt() {
  const value = promptEl.value.trim();
  if (!value) return;
  sendBtn.disabled = true;
  append('outgoing', value);
  try {
    const payload = { text: value };
    if (currentSession) payload.sessionId = currentSession;
    const res = await fetch(host + '/message', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) {
      const t = await res.text();
      append('error', 'HTTP error: '+t);
    } else {
      const data = await res.json();
      append('info', 'Sent id='+data.id);
    }
  } catch (e) {
    append('error', 'Network error '+e);
  } finally {
    sendBtn.disabled = false;
    promptEl.value='';
    promptEl.focus();
  }
}

sendBtn.addEventListener('click', sendPrompt);
promptEl.addEventListener('keydown', e => { if (e.key==='Enter') sendPrompt(); });

function connectSessionStream() {
  if (sessionEventSource) { sessionEventSource.close(); }
  const url = currentSession ? `${host}/events?session=${encodeURIComponent(currentSession)}` : `${host}/events`;
  sessionEventSource = new EventSource(url);
  const buffer = {};
  sessionEventSource.addEventListener('inbound', ev => {
    const data = JSON.parse(ev.data);
    append('inbound', data.text, { id: data.id });
  });
  sessionEventSource.addEventListener('fragment', ev => {
    const data = JSON.parse(ev.data);
    if (!buffer[data.id]) buffer[data.id] = '';
    buffer[data.id] += data.fragment;
    append('fragment', data.fragment, { id: data.id, model: data.model });
  });
  sessionEventSource.addEventListener('done', ev => {
    const data = JSON.parse(ev.data);
    append('done', 'Complete for id='+data.id+' (model '+data.model+')');
    if (buffer[data.id]) {
      const answerText = buffer[data.id];
      append('answer', answerText);
      notifyCompletion(data, answerText);
    } else {
      notifyCompletion(data, '');
    }
  });
}

async function refreshSessions() {
  try {
    const res = await fetch(host + '/sessions');
    if (!res.ok) return;
    const list = await res.json();
    const container = document.getElementById('sessions');
    container.innerHTML = '';
    sessionNameMap = {};
    list.forEach(s => {
      sessionNameMap[s.id] = s.name;
      const btn = document.createElement('button');
      btn.textContent = s.name;
      btn.style.display='block';
      btn.style.width='100%';
      btn.style.margin='0 0 4px';
      btn.style.background = (s.id===currentSession)?'#2b6cb0':'#2d3748';
      btn.style.fontSize='.8rem';
      btn.addEventListener('click', () => { currentSession = s.id; document.getElementById('log').innerHTML=''; document.getElementById('activeSessionLabel').textContent = 'Session: '+s.name; connectSessionStream(); });
      container.appendChild(btn);
    });
    // Auto-select first session if none selected
    if (!currentSession && list.length) {
      currentSession = list[0].id;
      document.getElementById('activeSessionLabel').textContent = 'Session: '+list[0].name;
      connectSessionStream();
    }
  } catch {}
}

// Notification Handling
function requestNotifyPermission() {
  if (!('Notification' in window)) { append('info','Notifications not supported'); return; }
  if (Notification.permission === 'default') {
    Notification.requestPermission().then(p => {
      append('info', 'Notification permission: '+p);
    });
  } else {
    append('info', 'Notification permission already: '+Notification.permission);
  }
}

function notifyCompletion(doneData, answer) {
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return; // silent if not granted
  try {
    const sessName = sessionNameMap[doneData.sessionId] || 'session';
    const snippet = (answer||'').replace(/\s+/g,' ').slice(0,140) + (answer && answer.length>140 ? 'â€¦' : '');
    new Notification(`Response complete (${sessName})`, { body: snippet || `id ${doneData.id} finished`, tag: doneData.id });
  } catch {}
}

document.getElementById('enableNotifyBtn').addEventListener('click', requestNotifyPermission);

refreshSessions();
connectSessionStream();
</script>
</body>
</html>